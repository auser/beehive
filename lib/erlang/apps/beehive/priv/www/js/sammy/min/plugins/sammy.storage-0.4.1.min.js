// -- Sammy -- /plugins/sammy.storage.js
// http://code.quirkey.com/sammy
// Version: 0.4.1
// Built: Mon Jan 11 22:02:13 -0500 2010
(function(a){Sammy=Sammy||{};Sammy.Store=function(b){this.options=b||{};this.name=this.options.name||"store";this.$element=a(this.options.element||"body");this.type=this.options.type||"memory";this.meta_key=this.options.meta_key||"__keys__";this.storage=new Sammy.Store[Sammy.Store.stores[this.type]](this.name,this.$element,this.options)};Sammy.Store.stores={memory:"Memory",data:"Data",local:"LocalStorage",session:"SessionStorage",cookie:"Cookie"};a.extend(Sammy.Store.prototype,{isAvailable:function(){if(a.isFunction(this.storage.isAvailable)){return this.storage.isAvailable()}else{true}},exists:function(b){return this.storage.exists(b)},set:function(b,c){c=(typeof c=="string")?c:JSON.stringify(c);if(b!=this.meta_key){this._addKey(b)}this.storage.set(b,c);this.$element.trigger("set-"+this.name+"."+b,[b,c]);this.$element.trigger("set-"+this.name,[b,c]);return c},get:function(b){var c=this.storage.get(b);if(typeof c=="undefined"||c==null||c==""){return c}try{return JSON.parse(c)}catch(d){return c}},clear:function(b){this._removeKey(b);return this.storage.clear(b)},clearAll:function(){var b=this;a.each(this.keys(),function(d,c){b.clear(c)})},keys:function(){return this.get(this.meta_key)||[]},fetch:function(b,c){if(!this.exists(b)){return this.set(b,c.apply(this))}else{return this.get(b)}},_addKey:function(b){var c=this.keys();if(a.inArray(b,c)==-1){c.push(b)}this.set(this.meta_key,c)},_removeKey:function(c){var d=this.keys();var b=a.inArray(c,d);if(b!=-1){d.splice(b,1)}this.set(this.meta_key,d)}});Sammy.Store.isAvailable=function(b){return Sammy.Store[Sammy.Store.stores[b]].prototype.isAvailable()};Sammy.Store.Memory=function(b){this.name=b;Sammy.Store.Memory.store=Sammy.Store.Memory.store||{};Sammy.Store.Memory.store[b]=Sammy.Store.Memory.store[b]||{};this.store=Sammy.Store.Memory.store[b]};a.extend(Sammy.Store.Memory.prototype,{exists:function(b){return(typeof this.store[b]!="undefined")},set:function(b,c){return this.store[b]=c},get:function(b){return this.store[b]},clear:function(b){delete this.store[b]}});Sammy.Store.Data=function(c,b){this.name=c;this.$element=b};a.extend(Sammy.Store.Data.prototype,{exists:function(b){return(typeof this.$element.data(this._key(b))!="undefined")},set:function(b,c){return this.$element.data(this._key(b),c)},get:function(b){return this.$element.data(this._key(b))},clear:function(b){this.$element.removeData(this._key(b))},_key:function(b){return["store",this.name,b].join(".")}});Sammy.Store.LocalStorage=function(b){this.name=b};a.extend(Sammy.Store.LocalStorage.prototype,{isAvailable:function(){return("localStorage" in window)&&(window.location.protocol!="file:")},exists:function(b){return(this.get(b)!=null)},set:function(b,c){return window.localStorage.setItem(this._key(b),c)},get:function(b){return window.localStorage.getItem(this._key(b))},clear:function(b){window.localStorage.removeItem(this._key(b))},_key:function(b){return["store",this.name,b].join(".")}});Sammy.Store.SessionStorage=function(b){this.name=b};a.extend(Sammy.Store.SessionStorage.prototype,{isAvailable:function(){return("sessionStorage" in window)},exists:function(b){return(this.get(b)!=null)},set:function(b,c){return window.sessionStorage.setItem(this._key(b),c)},get:function(b){return window.sessionStorage.getItem(this._key(b))},clear:function(b){window.sessionStorage.removeItem(this._key(b))},_key:function(b){return["store",this.name,b].join(".")}});Sammy.Store.Cookie=function(d,b,c){this.name=d;this.$element=b;this.options=c||{};this.path=this.options.path||"/";this.expires_in=this.options.expires_in||(14*24*60*60)};a.extend(Sammy.Store.Cookie.prototype,{isAvailable:function(){return("cookie" in document)},exists:function(b){return(this.get(b)!=null)},set:function(b,c){return this._setCookie(b,c)},get:function(b){return this._getCookie(b)},clear:function(b){this._setCookie(b,"",-1)},_key:function(b){return["store",this.name,b].join(".")},_getCookie:function(c){var d=this._key(c).replace(/(\.|\*|\(|\)|\[|\])/g,"\\$1");var b=document.cookie.match("(^|;\\s)"+d+"=([^;]*)(;|$)");return(b?b[2]:null)},_setCookie:function(e,f,c){if(!c){c=(this.expires_in*1000)}var d=new Date();d.setTime(d.getTime()+c);var b=[this._key(e),"=",f,"; expires=",d.toGMTString(),"; path=",this.path].join("");document.cookie=b}});Sammy.Storage=function(b){this.use(Sammy.JSON);this.stores=this.stores||{};this.store=function(d,c){if(typeof this.stores[d]=="undefined"){this.stores[d]=new Sammy.Store(a.extend({name:d,element:this.element_selector},c||{}));this[d]=function(e,f){if(typeof f=="undefined"){return this.stores[d].get(e)}else{if(a.isFunction(f)){return this.stores[d].fetch(e,f)}else{return this.stores[d].set(e,f)}}};this.helper(d,function(){return this.app[d].apply(this.app,arguments)})}return this.stores[d]};this.helpers({store:function(){return this.app.store.apply(this.app,arguments)}})};Sammy.Session=function(d,b){this.use(Sammy.Storage);var c="memory";if(Sammy.Store.isAvailable("local")){c="local"}else{if(Sammy.Store.isAvailable("cookie")){c="cookie"}}this.store("session",a.extend({type:c},b))}})(jQuery);